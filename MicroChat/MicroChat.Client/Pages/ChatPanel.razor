@using MicroChat.Client.Models
@using MicroChat.Client.Services
@using System.Text
@inject ConversationService ConversationService
@inject ChatService ChatService
@implements IDisposable

@if (ConversationService.SelectedConversation != null)
{
    <div class="chat-panel">
        <div class="chat-messages" @ref="_messagesContainer">
            @foreach (var message in ConversationService.SelectedConversation.Messages)
            {
                <div class="chat-message @(message.Sender == MessageRole.User ? "user-message" : "bot-message")">
                    <div class="message-content">@message.Content</div>
                    <div class="message-time" title="@message.Time.ToString("f", System.Globalization.CultureInfo.CurrentCulture)">
                        @message.Time.ToString("HH:mm")
                    </div>
                </div>
            }
            @if (_isStreaming && _streamingContent.Length > 0)
            {
                <div class="chat-message bot-message streaming">
                    <div class="message-content">@_streamingContent.ToString()</div>
                </div>
            }
        </div>
        <ChatInput IsStreaming="@_isStreaming" OnSendMessage="SendMessageAsync" />
    </div>
}
else
{
    <div class="chat-panel-empty">
        <h3>请从左侧选择一个聊天</h3>
    </div>
}

@code {
    private ElementReference _messagesContainer;
    private bool _isStreaming = false;
    private readonly StringBuilder _streamingContent = new();
    private CancellationTokenSource? _cts;

    protected override void OnInitialized()
    {
        ConversationService.OnChange += StateHasChanged;
    }

    private async Task SendMessageAsync(string userMessage)
    {
        if (ConversationService.SelectedConversation == null || string.IsNullOrWhiteSpace(userMessage))
            return;

        await AddUserMessageAsync(userMessage);
        await ProcessAiResponseAsync(userMessage);
    }

    private async Task AddUserMessageAsync(string userMessage)
    {
        var userMsg = new Message
        {
            Sender = MessageRole.User,
            Content = userMessage,
            Time = DateTime.Now,
            Model = ConversationService.SelectedConversation!.AIModel
        };
        ConversationService.SelectedConversation.Messages.Add(userMsg);
        await ConversationService.UpdateConversationAsync(ConversationService.SelectedConversation);
    }

    private async Task ProcessAiResponseAsync(string userMessage)
    {
        _isStreaming = true;
        _streamingContent.Clear();
        _cts = new CancellationTokenSource();
        
        try
        {
            await StreamAiResponseAsync(userMessage);
            await SaveAssistantMessageAsync();
        }
        catch (OperationCanceledException)
        {
            // 用户取消了请求
        }
        catch (Exception ex)
        {
            await AddErrorMessageAsync(ex.Message);
        }
        finally
        {
            ResetStreamingState();
        }
    }

    private async Task StreamAiResponseAsync(string userMessage)
    {
        await foreach (var chunk in ChatService.SendMessageStreamAsync(
            ConversationService.SelectedConversation!, 
            userMessage, 
            _cts!.Token))
        {
            _streamingContent.Append(chunk);
            StateHasChanged();
        }
    }

    private async Task SaveAssistantMessageAsync()
    {
        if (_streamingContent.Length == 0)
            return;

        var assistantMsg = new Message
        {
            Sender = MessageRole.Assistant,
            Content = _streamingContent.ToString(),
            Time = DateTime.Now,
            Model = ConversationService.SelectedConversation!.AIModel
        };
        ConversationService.SelectedConversation.Messages.Add(assistantMsg);
        await ConversationService.UpdateConversationAsync(ConversationService.SelectedConversation);
    }

    private async Task AddErrorMessageAsync(string errorMessage)
    {
        var errorMsg = new Message
        {
            Sender = MessageRole.Assistant,
            Content = $"发送失败: {errorMessage}",
            Time = DateTime.Now,
            Model = ConversationService.SelectedConversation!.AIModel
        };
        ConversationService.SelectedConversation.Messages.Add(errorMsg);
        await ConversationService.UpdateConversationAsync(ConversationService.SelectedConversation);
    }

    private void ResetStreamingState()
    {
        _isStreaming = false;
        _streamingContent.Clear();
        _cts?.Dispose();
        _cts = null;
        StateHasChanged();
    }

    public void Dispose()
    {
        ConversationService.OnChange -= StateHasChanged;
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
