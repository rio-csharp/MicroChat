@using MicroChat.Client.Models
@using MicroChat.Client.Services
@using System.Threading.Tasks
@inject ConversationService ConversationService
@inject ModelService ModelService
@implements IDisposable

<div class="chat-header">
    <div class="header-left">
        @if (ShowBackButton)
        {
            <button class="back-button" @onclick="HandleBackClick" title="返回">
                <ChatHeaderIcons Name="back" Width="24" Height="24" />
            </button>
        }
        <div class="model-icon">
            <Icon IconSlug="@ConversationService.SelectedConversation?.AIModel?.Provider?.IconSlug" />
        </div>
        <div class="model-title">@ConversationService.SelectedConversation?.Title</div>
    </div>

    <div class="header-right">

        @if (ConversationService.SelectedConversation != null)
        {
            <select class="model-selector" @bind="SelectedModelId" @bind:after="OnModelChangedAsync">
                @foreach (var model in Models)
                {
                    <option value="@model">@model</option>
                }
            </select>
        }

        <button class="container-toggle-button" @onclick="HandleToggleContainerMode" title="@(IsContainerMode ? "全宽模式" : "容器模式")">
            @if (IsContainerMode)
            {
                <ChatHeaderIcons Name="container_on" Width="20" Height="20" />
            }
            else
            {
                <ChatHeaderIcons Name="container_off" Width="20" Height="20" />
            }
        </button>

        <button class="settings-button" title="设置">
            <ChatHeaderIcons Name="settings" Width="20" Height="20" />
        </button>
    </div>
</div>

@code {
    [Parameter]
    public bool ShowBackButton { get; set; } = false;

    [Parameter]
    public EventCallback OnBackClicked { get; set; }

    [Parameter]
    public bool IsContainerMode { get; set; } = false;

    [Parameter]
    public EventCallback OnToggleContainerMode { get; set; }

    private List<string> Models { get; set; } = new();
    private string SelectedModelId { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var models = await ModelService.GetModelsAsync();
        if (models != null && models.Count > 0)
        {
            Models = models.ToList();
            var currentModelId = ConversationService.SelectedConversation?.AIModel?.Id;
            
            if (!string.IsNullOrEmpty(currentModelId) && Models.Contains(currentModelId))
            {
                SelectedModelId = currentModelId;
            }
            else
            {
                SelectedModelId = Models.First();
            }
        }
        ConversationService.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        ConversationService.OnChange -= StateHasChanged;
    }

    private async Task OnModelChangedAsync()
    {
        ConversationService.SelectedConversation!.AIModel = new AIModel()
        {
            Id = SelectedModelId,
            Name = SelectedModelId
        };
        await ConversationService.UpdateConversationAsync(ConversationService.SelectedConversation);
    }

    private void HandleBackClick()
    {
        OnBackClicked.InvokeAsync();
    }

    private void HandleToggleContainerMode()
    {
        OnToggleContainerMode.InvokeAsync();
    }
}
