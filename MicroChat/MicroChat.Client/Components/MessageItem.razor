@using MicroChat.Client.Models
@using MicroChat.Client.Pages
@using MicroChat.Client.Services
@using Microsoft.JSInterop
@inject MarkdownService MarkdownService
@inject IJSRuntime JSRuntime
@inject ConversationService ConversationService
@implements IAsyncDisposable

@if (Message.Sender == MessageRole.User)
{
    <div class="message-wrapper user-wrapper">
        <div class="user-time">@Message.Time.ToString("HH:mm")</div>
        <div class="chat-message user-message">
            <div class="message-content">@Content</div>
        </div>
        <div class="message-actions">
            <button class="action-btn" @onclick="CopyMessageAsync" title="复制">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
            <button class="action-btn delete-btn" @onclick="DeleteMessageAsync" title="删除">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
        </div>
    </div>
}
else
{
    <div class="message-wrapper bot-wrapper">
        <div class="bot-header">
            <div class="bot-icon">
                <Icon IconSlug="@Message.Model?.Provider?.IconSlug" Height="24" />
            </div>
            <div class="bot-info">
                <span class="bot-model">@(Message.Model?.Name ?? "AI Assistant")</span>
                <span class="bot-time">@Message.Time.ToString("HH:mm")</span>
            </div>
        </div>
        <div class="chat-message bot-message @(IsStreaming ? "streaming" : "")" @ref="_messageElement">
            <div class="message-content markdown-content">
                @((MarkupString)RenderedContent)
            </div>
        </div>
        @if (!IsStreaming)
        {
            <div class="message-actions">
                <button class="action-btn" @onclick="CopyMessageAsync" title="复制">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
                <button class="action-btn delete-btn" @onclick="DeleteMessageAsync" title="删除">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        }
    </div>
}

@code {
    [Parameter, EditorRequired]
    public Message Message { get; set; } = default!;

    [Parameter]
    public string? Content { get; set; }

    [Parameter]
    public bool IsStreaming { get; set; } = false;

    private string RenderedContent { get; set; } = string.Empty;
    private ElementReference _messageElement;
    private IJSObjectReference? _codeBlockModule;

    protected override void OnParametersSet()
    {
        // 如果没有提供自定义内容，使用消息的内容
        Content ??= Message.Content;
        
        // 渲染 Markdown（仅对 AI 消息）
        if (Message.Sender != MessageRole.User)
        {
            RenderedContent = MarkdownService.ToHtml(Content ?? string.Empty);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // 仅对 AI 消息初始化代码块
        if (Message.Sender != MessageRole.User && !IsStreaming)
        {
            try
            {
                _codeBlockModule ??= await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./js/codeBlock.js");
                
                await _codeBlockModule.InvokeVoidAsync("initializeCodeBlocks", _messageElement);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing code blocks: {ex.Message}");
            }
        }
    }

    private async Task CopyMessageAsync()
    {
        try
        {
            var contentToCopy = Content ?? Message.Content;
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", contentToCopy);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error copying to clipboard: {ex.Message}");
        }
    }

    private async Task DeleteMessageAsync()
    {
        if (ConversationService.SelectedConversation != null)
        {
            await ConversationService.DeleteMessageAsync(
                ConversationService.SelectedConversation.Id,
                Message.Id
            );
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_codeBlockModule is not null)
        {
            try
            {
                await _codeBlockModule.InvokeVoidAsync("cleanupCodeBlocks", _messageElement);
                await _codeBlockModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // 忽略 JS 断开连接的异常
            }
        }
    }
}
