@using MicroChat.Client.Models
@using MicroChat.Client.Pages
@using MicroChat.Client.Services
@using Microsoft.JSInterop
@inject MarkdownService MarkdownService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (Message.Sender == MessageRole.User)
{
    <div class="message-wrapper user-wrapper">
        <div class="user-time">@Message.Time.ToString("HH:mm")</div>
        <div class="chat-message user-message">
            <div class="message-content">@Content</div>
        </div>
    </div>
}
else
{
    <div class="message-wrapper bot-wrapper">
        <div class="bot-header">
            <div class="bot-icon">
                <Icon IconSlug="@Message.Model?.Provider?.IconSlug" Height="24" />
            </div>
            <div class="bot-info">
                <span class="bot-model">@(Message.Model?.Name ?? "AI Assistant")</span>
                <span class="bot-time">@Message.Time.ToString("HH:mm")</span>
            </div>
        </div>
        <div class="chat-message bot-message @(IsStreaming ? "streaming" : "")" @ref="_messageElement">
            <div class="message-content markdown-content">
                @((MarkupString)RenderedContent)
            </div>
        </div>
    </div>
}

@code {
    [Parameter, EditorRequired]
    public Message Message { get; set; } = default!;

    [Parameter]
    public string? Content { get; set; }

    [Parameter]
    public bool IsStreaming { get; set; } = false;

    private string RenderedContent { get; set; } = string.Empty;
    private ElementReference _messageElement;
    private IJSObjectReference? _codeBlockModule;

    protected override void OnParametersSet()
    {
        // 如果没有提供自定义内容，使用消息的内容
        Content ??= Message.Content;
        
        // 渲染 Markdown（仅对 AI 消息）
        if (Message.Sender != MessageRole.User)
        {
            RenderedContent = MarkdownService.ToHtml(Content ?? string.Empty);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // 仅对 AI 消息初始化代码块
        if (Message.Sender != MessageRole.User && !IsStreaming)
        {
            try
            {
                _codeBlockModule ??= await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./js/codeBlock.js");
                
                await _codeBlockModule.InvokeVoidAsync("initializeCodeBlocks", _messageElement);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing code blocks: {ex.Message}");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_codeBlockModule is not null)
        {
            try
            {
                await _codeBlockModule.InvokeVoidAsync("cleanupCodeBlocks", _messageElement);
                await _codeBlockModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // 忽略 JS 断开连接的异常
            }
        }
    }
}
